name: CI

on:
  push:
    branches:
      - '**'
  pull_request:

jobs:
  build:

    permissions:
      contents: read
      pull-requests: write

    strategy:
      matrix:
        os: [ macos-latest, ubuntu-latest, windows-latest ]
        node-version: [ 20 ]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Install Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - name: Install dependencies
      run: npm install
    - name: Execute tests (Linux)
      if: runner.os == 'Linux'
      run: |
        set +e
        xvfb-run -a npm run all
        TEST_EXIT_CODE=$?
        set -e
        node scripts/ui-test.js
        exit $TEST_EXIT_CODE
    - name: Upload UI Screenshots
      if: always() && runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: ui-screenshots
        path: |
          ui-default-en.png
          ui-chinese.png
          ui-japanese.png
          ui-sidebar-custom-props.png
    - name: Comment on PR
      if: always() && runner.os == 'Linux' && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `Automated UI tests completed. The following screenshots have been uploaded to the job artifacts named "ui-screenshots":
            - ui-default-en.png (English)
            - ui-chinese.png (Chinese)
            - ui-japanese.png (Japanese)
            - ui-sidebar-custom-props.png (Sidebar & Custom Properties)

            Please download the artifacts to view the results.`
          })
    - name: Execute tests (MacOS, Windows)
      run: npm run all
      if: runner.os != 'Linux'
    - name: Dry-run release
      run: npx @vscode/vsce ls
